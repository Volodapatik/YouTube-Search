<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîí File Transfer Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0f0f0f, #1a1a1a);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(30, 30, 30, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            border: 1px solid #333;
        }

        /* –°–ø—Ä–æ—â–µ–Ω–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
        .header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #00cc6a;
        }

        .header h1 {
            font-size: 24px;
            color: #00ff88;
            margin-bottom: 5px;
        }

        .header .subtitle {
            color: #aaa;
            font-size: 14px;
        }

        /* –ö–æ–º–ø–∞–∫—Ç–Ω—ñ —Å–µ–∫—Ü—ñ—ó */
        .main-section {
            display: block;
        }

        .upload-section {
            border: 2px dashed #444;
            border-radius: 12px;
            padding: 30px 15px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.2);
        }

        .upload-section:hover {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.05);
        }

        .upload-icon {
            font-size: 36px;
            margin-bottom: 10px;
            color: #00ff88;
        }

        .upload-text {
            color: #ddd;
            margin-bottom: 5px;
            font-size: 16px;
        }

        .upload-hint {
            color: #888;
            font-size: 12px;
        }

        /* –ö–æ–º–ø–∞–∫—Ç–Ω—ñ –∫–Ω–æ–ø–∫–∏ */
        .btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #00cc6a, #00aa55);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        }

        .btn-wide {
            width: 100%;
        }

        /* –°—Ç–∏–ª—ñ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á—ñ */
        .transfer-options {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .transfer-option {
            flex: 1;
            min-width: 200px;
            padding: 20px;
            background: #1a1a1a;
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .transfer-option:hover {
            border-color: #00cc6a;
            transform: translateY(-2px);
        }

        .transfer-option.active {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }

        .transfer-icon {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .transfer-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #00ff88;
        }

        .transfer-desc {
            font-size: 12px;
            color: #aaa;
        }

        /* –ö–æ–¥ –ø–µ—Ä–µ–¥–∞—á—ñ */
        .code-display {
            background: #111;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            font-family: 'Courier New', monospace;
            font-size: 20px;
            letter-spacing: 3px;
            border: 1px solid #00ff88;
            word-break: break-all;
        }

        /* QR-–∫–æ–¥ */
        .qr-container {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: #111;
            border-radius: 10px;
            display: none;
        }

        .qr-code {
            width: 180px;
            height: 180px;
            margin: 15px auto;
            background: white;
            padding: 10px;
            border-radius: 8px;
        }

        /* –ü–æ–ª–µ –≤–≤–æ–¥—É –∫–æ–¥—É */
        .code-input-container {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .code-input {
            flex: 1;
            padding: 12px;
            background: #222;
            border: 2px solid #333;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            text-align: center;
            letter-spacing: 3px;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
        }

        .code-input:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 8px rgba(0, 255, 136, 0.3);
        }

        /* –ü—Ä–æ–≥—Ä–µ—Å –±–∞—Ä */
        .progress-container {
            margin: 15px 0;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00cc6a);
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            font-size: 12px;
            color: #aaa;
            text-align: center;
        }

        /* –°—Ç–∞—Ç—É—Å */
        .status-message {
            padding: 12px;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            display: none;
        }

        .status-message.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        /* –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª—ñ–≤ */
        .files-list {
            max-height: 300px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #333;
            margin-top: 20px;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #333;
            transition: all 0.2s;
        }

        .file-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .file-icon {
            width: 32px;
            height: 32px;
            background: #333;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 16px;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-size: 14px;
            margin-bottom: 2px;
            word-break: break-word;
        }

        .file-size {
            color: #888;
            font-size: 11px;
        }

        /* –ö–Ω–æ–ø–∫–∏ –¥—ñ–π */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 10px 15px;
            background: #333;
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .action-btn:hover {
            background: #444;
            transform: translateY(-1px);
        }

        /* –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: #222;
            border-radius: 12px;
            padding: 25px;
            max-width: 500px;
            width: 100%;
            border: 1px solid #00ff88;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }

        .modal-title {
            color: #00ff88;
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }

        /* –ê–Ω—ñ–º–∞—Ü—ñ—ó */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Toast –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #00ff88;
            color: #000;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 500;
            z-index: 1001;
            animation: fadeIn 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            font-size: 14px;
        }

        .toast.error {
            background: #ff4444;
            color: white;
        }

        .toast.warning {
            background: #ffc107;
            color: #000;
        }

        .toast.info {
            background: #2196f3;
            color: white;
        }

        /* –ö–∞–º–µ—Ä–∞ */
        .camera-container {
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            background: #111;
            border-radius: 8px;
            display: none;
        }

        .camera-container.active {
            display: block;
        }

        #cameraVideo {
            width: 100%;
            max-width: 280px;
            border-radius: 8px;
            margin: 10px 0;
            background: #000;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .transfer-options {
                flex-direction: column;
            }
            
            .transfer-option {
                min-width: 100%;
            }
            
            .code-input-container {
                flex-direction: column;
            }
            
            .modal-content {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 20px;
            }
            
            .code-display {
                font-size: 18px;
                letter-spacing: 2px;
            }
            
            .qr-code {
                width: 150px;
                height: 150px;
            }
        }

        /* –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #222;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* –ü–æ–ª–µ –¥–ª—è —Ñ–∞–π–ª—ñ–≤ */
        #fileInput {
            display: none;
        }

        /* –í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å —Ñ–∞–π–ª—ñ–≤ */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-icon {
            font-size: 36px;
            margin-bottom: 10px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-section">
            <div class="header">
                <h1>üì§ –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ —Ñ–∞–π–ª–∏</h1>
                <p class="subtitle">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–æ–¥ –¥–ª—è –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ –Ω–∞ —ñ–Ω—à–∏–π –ø—Ä–∏—Å—Ç—Ä—ñ–π</p>
            </div>
            
            <!-- –û–±–ª–∞—Å—Ç—å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ -->
            <div id="uploadArea" class="upload-section">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">
                    <strong>–ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å —Ñ–∞–π–ª–∏ —Å—é–¥–∏</strong> –∞–±–æ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –≤–∏–±–æ—Ä—É
                </div>
                <div class="upload-hint">
                    –ü—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å—Å—è —Ñ–∞–π–ª–∏ –±—É–¥—å-—è–∫–æ–≥–æ —Ä–æ–∑–º—ñ—Ä—É
                </div>
                <input type="file" id="fileInput" multiple>
            </div>
            
            <!-- –í–∏–±—Ä–∞–Ω—ñ —Ñ–∞–π–ª–∏ -->
            <div id="selectedFiles" class="files-list" style="display: none;">
                <!-- –§–∞–π–ª–∏ –±—É–¥—É—Ç—å –¥–æ–¥–∞–Ω—ñ —Ç—É—Ç -->
            </div>
            
            <!-- –û–ø—Ü—ñ—ó –ø–µ—Ä–µ–¥–∞—á—ñ -->
            <div class="transfer-options">
                <div class="transfer-option active" onclick="setTransferType('direct')" id="directOption">
                    <div class="transfer-icon">‚ö°</div>
                    <div class="transfer-title">–ü—Ä—è–º–∞ –ø–µ—Ä–µ–¥–∞—á–∞</div>
                    <div class="transfer-desc">–ë—É–¥—å-—è–∫—ñ —Ñ–∞–π–ª–∏ —á–µ—Ä–µ–∑ IndexedDB</div>
                </div>
                
                <div class="transfer-option" onclick="setTransferType('fast')" id="fastOption">
                    <div class="transfer-icon">üöÄ</div>
                    <div class="transfer-title">–®–≤–∏–¥–∫–∞ –ø–µ—Ä–µ–¥–∞—á–∞</div>
                    <div class="transfer-desc">–§–∞–π–ª–∏ –¥–æ 10 –ú–ë —á–µ—Ä–µ–∑ localStorage</div>
                </div>
            </div>
            
            <!-- –ö–æ–¥ –ø–µ—Ä–µ–¥–∞—á—ñ -->
            <div id="codeSection" style="display: none;">
                <div class="code-display" id="shareCodeDisplay">
                    –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–æ–¥"
                </div>
                
                <!-- QR-–∫–æ–¥ -->
                <div id="qrContainer" class="qr-container">
                    <p>–ê–±–æ –≤—ñ–¥—Å–∫–∞–Ω—É–π—Ç–µ QR-–∫–æ–¥:</p>
                    <div class="qr-code" id="qrCode"></div>
                </div>
                
                <!-- –°—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–¥–∞—á—ñ -->
                <div id="shareStatus" class="status-message">
                    <p>‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –ø—Ä–∏—Å—Ç—Ä–æ—é...</p>
                    <p style="font-size: 12px; margin-top: 5px;" id="shareStatusDetails">
                        –ö–æ–¥ –∞–∫—Ç–∏–≤–Ω–∏–π 10 —Ö–≤–∏–ª–∏–Ω
                    </p>
                </div>
                
                <!-- –ü—Ä–æ–≥—Ä–µ—Å –ø–µ—Ä–µ–¥–∞—á—ñ -->
                <div id="transferProgress" class="progress-container">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span id="transferStatus">–ü–µ—Ä–µ–¥–∞—á–∞ —Ñ–∞–π–ª—ñ–≤...</span>
                        <span id="transferPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="transferFill"></div>
                    </div>
                    <div class="progress-text" id="transferSpeed">
                        –®–≤–∏–¥–∫—ñ—Å—Ç—å: -- ‚Ä¢ –ó–∞–ª–∏—à–∏–ª–æ—Å—å: --
                    </div>
                </div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∏ –¥—ñ–π -->
            <div class="action-buttons">
                <button class="btn" onclick="generateShareCode()" id="generateBtn">
                    üîÑ –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–æ–¥ –ø–µ—Ä–µ–¥–∞—á—ñ
                </button>
                
                <button class="action-btn" onclick="openReceiveModal()">
                    üì• –û—Ç—Ä–∏–º–∞—Ç–∏ —Ñ–∞–π–ª–∏
                </button>
                
                <button class="action-btn" onclick="showQRCode()" id="qrBtn" style="display: none;">
                    üì∑ –ü–æ–∫–∞–∑–∞—Ç–∏ QR-–∫–æ–¥
                </button>
                
                <button class="action-btn" onclick="copyShareCode()" id="copyBtn" style="display: none;">
                    üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏ –∫–æ–¥
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ -->
    <div id="receiveModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üì• –û—Ç—Ä–∏–º–∞—Ç–∏ —Ñ–∞–π–ª–∏</div>
                <button class="modal-close" onclick="closeReceiveModal()">√ó</button>
            </div>
            
            <div style="text-align: center; margin: 20px 0;">
                <p>–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤:</p>
                
                <div class="code-input-container">
                    <input type="text" id="receiveCodeInput" class="code-input" placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ (6 —Å–∏–º–≤–æ–ª—ñ–≤)" maxlength="6">
                    <button class="btn" onclick="connectToShare()">
                        üîó –ü—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è
                    </button>
                </div>
                
                <!-- –°—Ç–∞—Ç—É—Å –æ—Ç—Ä–∏–º–∞–Ω–Ω—è -->
                <div id="receiveStatus" class="status-message">
                    <p>‚è≥ –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –ø—Ä–∏—Å—Ç—Ä–æ—é...</p>
                    <p style="font-size: 12px; margin-top: 5px;" id="receiveStatusDetails">
                        –ü–æ—à—É–∫ –ø—Ä–∏—Å—Ç—Ä–æ—é...
                    </p>
                </div>
                
                <!-- –ü—Ä–æ–≥—Ä–µ—Å –æ—Ç—Ä–∏–º–∞–Ω–Ω—è -->
                <div id="receiveProgress" class="progress-container">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>–û—Ç—Ä–∏–º–∞–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤...</span>
                        <span id="receivePercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="receiveFill"></div>
                    </div>
                    <div class="progress-text" id="receiveSpeed">
                        –û—Ç—Ä–∏–º–∞–Ω–æ: 0 –ë ‚Ä¢ –ó–∞–ª–∏—à–∏–ª–æ—Å—å: --
                    </div>
                </div>
                
                <!-- –ö–∞–º–µ—Ä–∞ -->
                <div style="margin-top: 20px;">
                    <p style="color: #aaa; font-size: 14px; margin-bottom: 10px;">
                        –ê–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –∫–∞–º–µ—Ä—É –¥–ª—è —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è QR-–∫–æ–¥—É:
                    </p>
                    <button class="action-btn" onclick="toggleCamera()" id="cameraToggleBtn">
                        üì∑ –£–≤—ñ–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É
                    </button>
                </div>
                
                <div id="cameraContainer" class="camera-container">
                    <video id="cameraVideo" autoplay playsinline></video>
                    <p style="font-size: 12px; color: #888; margin-top: 10px;">
                        –ù–∞–≤–µ–¥—ñ—Ç—å –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥
                    </p>
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∏ -->
                <div style="margin-top: 20px;">
                    <button class="action-btn" onclick="closeReceiveModal()" style="background: #444;">
                        ‚úï –°–∫–∞—Å—É–≤–∞—Ç–∏
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏
        const MAX_FAST_SIZE = 10 * 1024 * 1024; // 10 –ú–ë –¥–ª—è —à–≤–∏–¥–∫–æ—ó –ø–µ—Ä–µ–¥–∞—á—ñ
        const SHARE_TIMEOUT = 10 * 60 * 1000; // 10 —Ö–≤–∏–ª–∏–Ω
        const CHUNK_SIZE = 5 * 1024 * 1024; // 5 –ú–ë —á–∞–Ω–∫–∏
        
        // –°—Ç–∞–Ω
        let files = [];
        let shareCode = null;
        let shareInterval = null;
        let transferType = 'direct';
        let isTransferring = false;
        let isReceiving = false;
        let cameraStream = null;
        let qrScanner = null;
        
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
        document.addEventListener('DOMContentLoaded', function() {
            initUpload();
            initDatabase();
        });
        
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        function initUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            // –ö–ª—ñ–∫ –Ω–∞ –æ–±–ª–∞—Å—Ç—å
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });
            
            // –í–∏–±—Ä–∞–Ω–æ —Ñ–∞–π–ª–∏
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
            
            // Drag & Drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#00ff88';
                uploadArea.style.background = 'rgba(0, 255, 136, 0.1)';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '#444';
                uploadArea.style.background = '';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#444';
                uploadArea.style.background = '';
                
                if (e.dataTransfer.files.length > 0) {
                    handleFiles(e.dataTransfer.files);
                }
            });
        }
        
        // –û–±—Ä–æ–±–∫–∞ —Ñ–∞–π–ª—ñ–≤
        function handleFiles(fileList) {
            const selectedFilesDiv = document.getElementById('selectedFiles');
            
            // –û—á–∏—Å—Ç–∏—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ —Ñ–∞–π–ª–∏
            files = Array.from(fileList);
            selectedFilesDiv.innerHTML = '';
            
            if (files.length === 0) {
                selectedFilesDiv.style.display = 'none';
                return;
            }
            
            selectedFilesDiv.style.display = 'block';
            
            // –î–æ–¥–∞—Ç–∏ —Ñ–∞–π–ª–∏ –¥–æ —Å–ø–∏—Å–∫—É
            files.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-icon">${getFileIcon(file.name)}</div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${formatFileSize(file.size)}</div>
                    </div>
                    <div style="color: #888; font-size: 12px;">
                        ${file.size > MAX_FAST_SIZE ? '‚ö°' : 'üöÄ'}
                    </div>
                `;
                selectedFilesDiv.appendChild(fileItem);
            });
            
            // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ä–æ–∑–º—ñ—Ä–∏ —Ñ–∞–π–ª—ñ–≤
            const largeFiles = files.filter(f => f.size > MAX_FAST_SIZE);
            if (largeFiles.length > 0 && transferType === 'fast') {
                showToast(`${largeFiles.length} —Ñ–∞–π–ª—ñ–≤ > 10 –ú–ë. –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–±—Ä–∞–Ω–æ –ø—Ä—è–º—É –ø–µ—Ä–µ–¥–∞—á—É.`, 'warning');
                setTransferType('direct');
            }
            
            showToast(`–î–æ–¥–∞–Ω–æ ${files.length} —Ñ–∞–π–ª—ñ–≤`, 'info');
        }
        
        // –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ —Ç–∏–ø –ø–µ—Ä–µ–¥–∞—á—ñ
        function setTransferType(type) {
            transferType = type;
            
            // –û–Ω–æ–≤–∏—Ç–∏ –≤—ñ–∑—É–∞–ª—å–Ω–∏–π –≤–∏–±—ñ—Ä
            document.getElementById('directOption').classList.remove('active');
            document.getElementById('fastOption').classList.remove('active');
            document.getElementById(type + 'Option').classList.add('active');
            
            // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ñ–∞–π–ª–∏
            const largeFiles = files.filter(f => f.size > MAX_FAST_SIZE);
            if (largeFiles.length > 0 && type === 'fast') {
                showToast(`${largeFiles.length} —Ñ–∞–π–ª—ñ–≤ > 10 –ú–ë. –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–±—Ä–∞–Ω–æ –ø—Ä—è–º—É –ø–µ—Ä–µ–¥–∞—á—É.`, 'warning');
                setTransferType('direct');
                return;
            }
            
            showToast(`–í–∏–±—Ä–∞–Ω–æ ${type === 'direct' ? '–ø—Ä—è–º—É' : '—à–≤–∏–¥–∫—É'} –ø–µ—Ä–µ–¥–∞—á—É`, 'info');
        }
        
        // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∫–æ–¥—É –ø–µ—Ä–µ–¥–∞—á—ñ
        async function generateShareCode() {
            if (files.length === 0) {
                showToast('–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª–∏', 'error');
                return;
            }
            
            // –ì–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –∫–æ–¥
            shareCode = generateRandomCode(6);
            
            // –ü–æ–∫–∞–∑–∞—Ç–∏ —Å–µ–∫—Ü—ñ—é –∑ –∫–æ–¥–æ–º
            document.getElementById('codeSection').style.display = 'block';
            document.getElementById('shareCodeDisplay').textContent = shareCode;
            document.getElementById('shareStatus').classList.add('active');
            document.getElementById('qrBtn').style.display = 'inline-flex';
            document.getElementById('copyBtn').style.display = 'inline-flex';
            
            // –û–Ω–æ–≤–∏—Ç–∏ –∫–Ω–æ–ø–∫—É
            document.getElementById('generateBtn').innerHTML = 'üîÑ –û–Ω–æ–≤–∏—Ç–∏ –∫–æ–¥';
            document.getElementById('generateBtn').onclick = refreshShareCode;
            
            // –ü—ñ–¥–≥–æ—Ç—É–≤–∞—Ç–∏ –ø–µ—Ä–µ–¥–∞—á—É
            await prepareTransfer();
            
            // –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
            startShareListening();
            
            showToast(`–ö–æ–¥ —Å—Ç–≤–æ—Ä–µ–Ω–æ: ${shareCode}. –ß–µ–∫–∞—î–º–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...`, 'info');
        }
        
        // –û–Ω–æ–≤–∏—Ç–∏ –∫–æ–¥
        function refreshShareCode() {
            stopShareListening();
            generateShareCode();
        }
        
        // –ü—ñ–¥–≥–æ—Ç—É–≤–∞—Ç–∏ –ø–µ—Ä–µ–¥–∞—á—É
        async function prepareTransfer() {
            if (transferType === 'fast') {
                await prepareFastTransfer();
            } else {
                await prepareDirectTransfer();
            }
        }
        
        // –ü—ñ–¥–≥–æ—Ç—É–≤–∞—Ç–∏ —à–≤–∏–¥–∫—É –ø–µ—Ä–µ–¥–∞—á—É
        async function prepareFastTransfer() {
            const smallFiles = files.filter(f => f.size <= MAX_FAST_SIZE);
            
            // –ü—Ä–æ—á–∏—Ç–∞—Ç–∏ —Ñ–∞–π–ª–∏ —è–∫ DataURL
            const filePromises = smallFiles.map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        resolve({
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            data: e.target.result
                        });
                    };
                    reader.readAsDataURL(file);
                });
            });
            
            const fileData = await Promise.all(filePromises);
            
            // –ó–±–µ—Ä–µ–≥—Ç–∏ –≤ localStorage
            const transferData = {
                code: shareCode,
                type: 'fast',
                files: fileData,
                timestamp: Date.now(),
                expires: Date.now() + SHARE_TIMEOUT
            };
            
            localStorage.setItem(`share_${shareCode}`, JSON.stringify(transferData));
            
            console.log('–®–≤–∏–¥–∫–∞ –ø–µ—Ä–µ–¥–∞—á–∞ –ø—ñ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞:', fileData.length, '—Ñ–∞–π–ª—ñ–≤');
        }
        
        // –ü—ñ–¥–≥–æ—Ç—É–≤–∞—Ç–∏ –ø—Ä—è–º—É –ø–µ—Ä–µ–¥–∞—á—É
        async function prepareDirectTransfer() {
            // –î–ª—è –ø—Ä—è–º–æ—ó –ø–µ—Ä–µ–¥–∞—á—ñ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ —Ñ–∞–π–ª–∏ –≤ IndexedDB
            const db = await getDatabase();
            
            // –û—á–∏—Å—Ç–∏—Ç–∏ —Å—Ç–∞—Ä—ñ –¥–∞–Ω—ñ
            await clearOldTransfers(db);
            
            // –ó–±–µ—Ä–µ–≥—Ç–∏ –º–µ—Ç–∞–¥–∞–Ω—ñ –ø–µ—Ä–µ–¥–∞—á—ñ
            const transferId = 'transfer_' + Date.now();
            const transferData = {
                id: transferId,
                code: shareCode,
                type: 'direct',
                files: files.map(f => ({
                    name: f.name,
                    type: f.type,
                    size: f.size,
                    lastModified: f.lastModified
                })),
                timestamp: Date.now(),
                expires: Date.now() + SHARE_TIMEOUT
            };
            
            // –ó–±–µ—Ä–µ–≥—Ç–∏ –≤ IndexedDB
            await saveToIndexedDB(db, 'transfers', transferData);
            
            // –ó–±–µ—Ä–µ–≥—Ç–∏ —Ñ–∞–π–ª–∏
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                if (file.size <= MAX_FAST_SIZE) {
                    // –ú–∞–ª–µ–Ω—å–∫—ñ —Ñ–∞–π–ª–∏ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ —Ü—ñ–ª–∏–º–∏
                    const fileData = await readFileAsDataURL(file);
                    await saveToIndexedDB(db, 'files', {
                        id: `file_${shareCode}_${i}`,
                        code: shareCode,
                        name: file.name,
                        data: fileData,
                        index: i
                    });
                } else {
                    // –í–µ–ª–∏–∫—ñ —Ñ–∞–π–ª–∏ —Ä–æ–∑–±–∏–≤–∞—î–º–æ –Ω–∞ —á–∞–Ω–∫–∏
                    await saveLargeFile(db, file, i);
                }
            }
            
            console.log('–ü—Ä—è–º–∞ –ø–µ—Ä–µ–¥–∞—á–∞ –ø—ñ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞:', files.length, '—Ñ–∞–π–ª—ñ–≤');
        }
        
        // –ó–±–µ—Ä–µ–≥—Ç–∏ –≤–µ–ª–∏–∫–∏–π —Ñ–∞–π–ª —É —á–∞–Ω–∫–∞—Ö
        async function saveLargeFile(db, file, fileIndex) {
            const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
            
            for (let chunkIndex = 0; chunkIndex < totalChunks; chunkIndex++) {
                const start = chunkIndex * CHUNK_SIZE;
                const end = Math.min(start + CHUNK_SIZE, file.size);
                const chunk = file.slice(start, end);
                
                const chunkData = await readFileAsDataURL(chunk);
                
                await saveToIndexedDB(db, 'chunks', {
                    id: `chunk_${shareCode}_${fileIndex}_${chunkIndex}`,
                    code: shareCode,
                    fileIndex: fileIndex,
                    chunkIndex: chunkIndex,
                    totalChunks: totalChunks,
                    data: chunkData,
                    timestamp: Date.now()
                });
            }
        }
        
        // –ü–æ—á–∞—Ç–æ–∫ –ø—Ä–æ—Å–ª—É—Ö–æ–≤—É–≤–∞–Ω–Ω—è –ø—ñ–¥–∫–ª—é—á–µ–Ω—å
        function startShareListening() {
            if (shareInterval) clearInterval(shareInterval);
            
            shareInterval = setInterval(async () => {
                if (!shareCode) return;
                
                // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Ç –Ω–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
                const requestKey = `connect_${shareCode}`;
                const requestData = localStorage.getItem(requestKey);
                
                if (requestData) {
                    const request = JSON.parse(requestData);
                    
                    // –í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–ø–∏—Ç
                    localStorage.removeItem(requestKey);
                    
                    // –ü–æ—á–∞—Ç–∏ –ø–µ—Ä–µ–¥–∞—á—É
                    await startTransfer(request);
                }
                
                // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ç–∞–π–º–∞—É—Ç
                const transferData = localStorage.getItem(`share_${shareCode}`);
                if (transferData) {
                    const data = JSON.parse(transferData);
                    if (Date.now() > data.expires) {
                        stopShareListening();
                        showToast('–ß–∞—Å –¥—ñ—ó –∫–æ–¥—É –≤–∏–π—à–æ–≤', 'warning');
                    }
                }
            }, 1000);
        }
        
        // –ü–æ—á–∞—Ç–∏ –ø–µ—Ä–µ–¥–∞—á—É
        async function startTransfer(request) {
            if (isTransferring) return;
            isTransferring = true;
            
            document.getElementById('transferProgress').style.display = 'block';
            document.getElementById('shareStatusDetails').textContent = '–ü—Ä–∏—Å—Ç—Ä—ñ–π –ø—ñ–¥–∫–ª—é—á–∏–≤—Å—è! –ü–æ—á–∞—Ç–æ–∫ –ø–µ—Ä–µ–¥–∞—á—ñ...';
            
            const startTime = Date.now();
            
            if (transferType === 'fast') {
                await transferFastFiles(request);
            } else {
                await transferDirectFiles(request);
            }
            
            const duration = (Date.now() - startTime) / 1000;
            showToast(`–ü–µ—Ä–µ–¥–∞—á—É –∑–∞–≤–µ—Ä—à–µ–Ω–æ –∑–∞ ${duration.toFixed(1)} —Å–µ–∫—É–Ω–¥`, 'info');
            
            isTransferring = false;
        }
        
        // –ü–µ—Ä–µ–¥–∞—á–∞ —à–≤–∏–¥–∫–∏—Ö —Ñ–∞–π–ª—ñ–≤
        async function transferFastFiles(request) {
            // –î–ª—è —à–≤–∏–¥–∫–æ—ó –ø–µ—Ä–µ–¥–∞—á—ñ —Ñ–∞–π–ª–∏ –≤–∂–µ –≤ localStorage
            // –ü—Ä–æ—Å—Ç–æ –æ–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–æ–≥—Ä–µ—Å
            updateTransferProgress(100, '–§–∞–π–ª–∏ –≥–æ—Ç–æ–≤—ñ –¥–æ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è');
        }
        
        // –ü–µ—Ä–µ–¥–∞—á–∞ –ø—Ä—è–º–∏—Ö —Ñ–∞–π–ª—ñ–≤
        async function transferDirectFiles(request) {
            // –î–ª—è –ø—Ä—è–º–æ—ó –ø–µ—Ä–µ–¥–∞—á—ñ —Ñ–∞–π–ª–∏ –≤ IndexedDB
            // –°—Ç–≤–æ—Ä—é—î–º–æ –∑–∞–ø–∏—Å –ø—Ä–æ –∞–∫—Ç–∏–≤–Ω—É –ø–µ—Ä–µ–¥–∞—á—É
            const transferRecord = {
                code: shareCode,
                receiver: request.deviceId,
                status: 'transferring',
                startTime: Date.now()
            };
            
            localStorage.setItem(`active_${shareCode}`, JSON.stringify(transferRecord));
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–æ–≥—Ä–µ—Å
            updateTransferProgress(50, '–ü–µ—Ä–µ–¥–∞—á–∞ —á–µ—Ä–µ–∑ IndexedDB...');
            
            // –ó–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è —ñ–º—ñ—Ç–∞—Ü—ñ—ó –ø–µ—Ä–µ–¥–∞—á—ñ
            await delay(2000);
            
            updateTransferProgress(100, '–ü–µ—Ä–µ–¥–∞—á—É –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
        }
        
        // –û–Ω–æ–≤–∏—Ç–∏ –ø—Ä–æ–≥—Ä–µ—Å –ø–µ—Ä–µ–¥–∞—á—ñ
        function updateTransferProgress(percent, status) {
            document.getElementById('transferPercent').textContent = percent + '%';
            document.getElementById('transferFill').style.width = percent + '%';
            document.getElementById('transferStatus').textContent = status;
            
            if (percent >= 100) {
                setTimeout(() => {
                    document.getElementById('transferProgress').style.display = 'none';
                }, 2000);
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç–∏ QR-–∫–æ–¥
        function showQRCode() {
            if (!shareCode) return;
            
            const qrContainer = document.getElementById('qrContainer');
            const qrCodeDiv = document.getElementById('qrCode');
            
            qrContainer.style.display = 'block';
            qrCodeDiv.innerHTML = '';
            
            if (typeof QRCode !== 'undefined') {
                new QRCode(qrCodeDiv, {
                    text: shareCode,
                    width: 160,
                    height: 160,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
        }
        
        // –ö–æ–ø—ñ—é–≤–∞—Ç–∏ –∫–æ–¥
        function copyShareCode() {
            if (!shareCode) return;
            
            navigator.clipboard.writeText(shareCode).then(() => {
                showToast('–ö–æ–¥ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É', 'info');
            }).catch(err => {
                // Fallback
                const textarea = document.createElement('textarea');
                textarea.value = shareCode;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showToast('–ö–æ–¥ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ', 'info');
            });
        }
        
        // üì• –§–£–ù–ö–¶–Ü–á –û–¢–†–ò–ú–ê–ù–ù–Ø
        
        // –í—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è
        function openReceiveModal() {
            document.getElementById('receiveModal').classList.add('active');
            document.getElementById('receiveCodeInput').focus();
        }
        
        // –ó–∞–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
        function closeReceiveModal() {
            document.getElementById('receiveModal').classList.remove('active');
            stopReceiving();
            if (cameraStream) {
                toggleCamera();
            }
        }
        
        // –ü—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ –ø–µ—Ä–µ–¥–∞—á—ñ
        async function connectToShare() {
            const code = document.getElementById('receiveCodeInput').value.trim().toUpperCase();
            
            if (!code || code.length !== 6) {
                showToast('–í–≤–µ–¥—ñ—Ç—å 6-–∑–Ω–∞—á–Ω–∏–π –∫–æ–¥', 'error');
                return;
            }
            
            isReceiving = true;
            document.getElementById('receiveStatus').classList.add('active');
            document.getElementById('receiveStatusDetails').textContent = '–ü–æ—à—É–∫ –ø–µ—Ä–µ–¥–∞—á—ñ...';
            
            // –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Ç –Ω–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
            const request = {
                code: code,
                deviceId: 'device_' + Date.now(),
                timestamp: Date.now()
            };
            
            localStorage.setItem(`connect_${code}`, JSON.stringify(request));
            
            // –ß–µ–∫–∞—Ç–∏ –Ω–∞ –ø—ñ–¥–≥–æ—Ç–æ–≤–∫—É –ø–µ—Ä–µ–¥–∞—á—ñ
            await waitForTransfer(code);
        }
        
        // –ß–µ–∫–∞—Ç–∏ –Ω–∞ –ø–µ—Ä–µ–¥–∞—á—É
        async function waitForTransfer(code) {
            let attempts = 0;
            const maxAttempts = 30;
            
            return new Promise((resolve) => {
                const checkInterval = setInterval(async () => {
                    attempts++;
                    
                    if (attempts >= maxAttempts) {
                        clearInterval(checkInterval);
                        document.getElementById('receiveStatusDetails').textContent = '–ü–µ—Ä–µ–¥–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞';
                        document.getElementById('receiveStatus').style.background = 'rgba(255, 68, 68, 0.1)';
                        isReceiving = false;
                        resolve(false);
                    } else {
                        document.getElementById('receiveStatusDetails').textContent = 
                            `–ü–æ—à—É–∫ –ø–µ—Ä–µ–¥–∞—á—ñ... (${attempts}/${maxAttempts})`;
                    }
                    
                    // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —à–≤–∏–¥–∫—É –ø–µ—Ä–µ–¥–∞—á—É
                    const fastData = localStorage.getItem(`share_${code}`);
                    if (fastData) {
                        clearInterval(checkInterval);
                        await receiveFastFiles(code, fastData);
                        resolve(true);
                        return;
                    }
                    
                    // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ø—Ä—è–º—É –ø–µ—Ä–µ–¥–∞—á—É
                    const db = await getDatabase();
                    const transferData = await getFromIndexedDB(db, 'transfers', 'code', code);
                    
                    if (transferData) {
                        clearInterval(checkInterval);
                        await receiveDirectFiles(code, transferData);
                        resolve(true);
                        return;
                    }
                }, 1000);
            });
        }
        
        // –û—Ç—Ä–∏–º–∞—Ç–∏ —à–≤–∏–¥–∫—ñ —Ñ–∞–π–ª–∏
        async function receiveFastFiles(code, fastDataString) {
            try {
                const fastData = JSON.parse(fastDataString);
                
                document.getElementById('receiveStatusDetails').textContent = 
                    `–ó–Ω–∞–π–¥–µ–Ω–æ ${fastData.files.length} —Ñ–∞–π–ª—ñ–≤`;
                document.getElementById('receiveProgress').style.display = 'block';
                
                let receivedCount = 0;
                
                for (const fileData of fastData.files) {
                    // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª
                    downloadFile(fileData);
                    receivedCount++;
                    
                    // –û–Ω–æ–≤–∏—Ç–∏ –ø—Ä–æ–≥—Ä–µ—Å
                    const percent = (receivedCount / fastData.files.length) * 100;
                    document.getElementById('receivePercent').textContent = percent.toFixed(1) + '%';
                    document.getElementById('receiveFill').style.width = percent + '%';
                    document.getElementById('receiveSpeed').textContent = 
                        `–û—Ç—Ä–∏–º–∞–Ω–æ: ${receivedCount}/${fastData.files.length} —Ñ–∞–π–ª—ñ–≤`;
                    
                    await delay(500); // –Ü–º—ñ—Ç–∞—Ü—ñ—è –∑–∞—Ç—Ä–∏–º–∫–∏
                }
                
                document.getElementById('receiveStatusDetails').textContent = 
                    `‚úÖ –û—Ç—Ä–∏–º–∞–Ω–æ ${receivedCount} —Ñ–∞–π–ª—ñ–≤!`;
                
                showToast(`–û—Ç—Ä–∏–º–∞–Ω–æ ${receivedCount} —Ñ–∞–π–ª—ñ–≤`, 'info');
                
                // –û—á–∏—Å—Ç–∏—Ç–∏ –¥–∞–Ω—ñ –ø–µ—Ä–µ–¥–∞—á—ñ
                localStorage.removeItem(`share_${code}`);
                
                setTimeout(() => closeReceiveModal(), 2000);
                
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è:', error);
                showToast('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤', 'error');
            }
            
            isReceiving = false;
        }
        
        // –û—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä—è–º—ñ —Ñ–∞–π–ª–∏
        async function receiveDirectFiles(code, transferData) {
            document.getElementById('receiveStatusDetails').textContent = 
                `–ó–Ω–∞–π–¥–µ–Ω–æ ${transferData.files.length} —Ñ–∞–π–ª—ñ–≤ (–ø—Ä—è–º–∞ –ø–µ—Ä–µ–¥–∞—á–∞)`;
            document.getElementById('receiveProgress').style.display = 'block';
            
            const db = await getDatabase();
            
            try {
                // –û—Ç—Ä–∏–º–∞—Ç–∏ –º–∞–ª–µ–Ω—å–∫—ñ —Ñ–∞–π–ª–∏
                const smallFiles = await getAllFromIndexedDB(db, 'files', 'code', code);
                
                let receivedCount = 0;
                const totalFiles = transferData.files.length;
                
                // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–∞–ª–µ–Ω—å–∫—ñ —Ñ–∞–π–ª–∏
                for (const fileData of smallFiles) {
                    downloadFile({
                        name: fileData.name,
                        data: fileData.data
                    });
                    receivedCount++;
                    
                    updateReceiveProgress(receivedCount, totalFiles);
                    await delay(500);
                }
                
                // –û—Ç—Ä–∏–º–∞—Ç–∏ –≤–µ–ª–∏–∫—ñ —Ñ–∞–π–ª–∏ –∑ —á–∞–Ω–∫—ñ–≤
                const fileGroups = {};
                const chunks = await getAllFromIndexedDB(db, 'chunks', 'code', code);
                
                // –ó–≥—Ä—É–ø—É–≤–∞—Ç–∏ —á–∞–Ω–∫–∏ –ø–æ —Ñ–∞–π–ª–∞–º
                chunks.forEach(chunk => {
                    if (!fileGroups[chunk.fileIndex]) {
                        fileGroups[chunk.fileIndex] = [];
                    }
                    fileGroups[chunk.fileIndex].push(chunk);
                });
                
                // –ó—ñ–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª–∏ –∑ —á–∞–Ω–∫—ñ–≤
                for (const fileIndex in fileGroups) {
                    const fileChunks = fileGroups[fileIndex].sort((a, b) => a.chunkIndex - b.chunkIndex);
                    const fileInfo = transferData.files[fileIndex];
                    
                    if (fileChunks.length > 0) {
                        // –ó—ñ–±—Ä–∞—Ç–∏ –¥–∞–Ω—ñ —Ñ–∞–π–ª—É
                        let combinedData = '';
                        fileChunks.forEach(chunk => {
                            const base64Data = chunk.data.split(',')[1] || '';
                            combinedData += base64Data;
                        });
                        
                        const fileData = {
                            name: fileInfo.name,
                            type: fileInfo.type,
                            data: 'data:' + fileInfo.type + ';base64,' + combinedData
                        };
                        
                        downloadFile(fileData);
                        receivedCount++;
                        
                        updateReceiveProgress(receivedCount, totalFiles);
                        await delay(1000);
                    }
                }
                
                document.getElementById('receiveStatusDetails').textContent = 
                    `‚úÖ –û—Ç—Ä–∏–º–∞–Ω–æ ${receivedCount} —Ñ–∞–π–ª—ñ–≤!`;
                
                showToast(`–û—Ç—Ä–∏–º–∞–Ω–æ ${receivedCount} —Ñ–∞–π–ª—ñ–≤ –∑ –ø—Ä—è–º–æ—ó –ø–µ—Ä–µ–¥–∞—á—ñ`, 'info');
                
                // –û—á–∏—Å—Ç–∏—Ç–∏ –¥–∞–Ω—ñ
                await clearTransferData(db, code);
                
                setTimeout(() => closeReceiveModal(), 2000);
                
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø—Ä—è–º–æ—ó –ø–µ—Ä–µ–¥–∞—á—ñ:', error);
                showToast('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤', 'error');
            }
            
            isReceiving = false;
        }
        
        // –û–Ω–æ–≤–∏—Ç–∏ –ø—Ä–æ–≥—Ä–µ—Å –æ—Ç—Ä–∏–º–∞–Ω–Ω—è
        function updateReceiveProgress(received, total) {
            const percent = (received / total) * 100;
            document.getElementById('receivePercent').textContent = percent.toFixed(1) + '%';
            document.getElementById('receiveFill').style.width = percent + '%';
            document.getElementById('receiveSpeed').textContent = 
                `–û—Ç—Ä–∏–º–∞–Ω–æ: ${received}/${total} —Ñ–∞–π–ª—ñ–≤`;
        }
        
        // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª
        function downloadFile(fileData) {
            const link = document.createElement('a');
            link.href = fileData.data;
            link.download = fileData.name;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // –ó—É–ø–∏–Ω–∏—Ç–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è
        function stopReceiving() {
            isReceiving = false;
            document.getElementById('receiveProgress').style.display = 'none';
            document.getElementById('receiveStatus').classList.remove('active');
        }
        
        // –ó—É–ø–∏–Ω–∏—Ç–∏ –ø—Ä–æ—Å–ª—É—Ö–æ–≤—É–≤–∞–Ω–Ω—è
        function stopShareListening() {
            if (shareInterval) {
                clearInterval(shareInterval);
                shareInterval = null;
            }
            
            if (shareCode) {
                localStorage.removeItem(`share_${shareCode}`);
                localStorage.removeItem(`connect_${shareCode}`);
                localStorage.removeItem(`active_${shareCode}`);
            }
        }
        
        // üì∑ –§–£–ù–ö–¶–Ü–á –ö–ê–ú–ï–†–ò
        
        // –£–≤—ñ–º–∫–Ω—É—Ç–∏/–≤–∏–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É
        async function toggleCamera() {
            const cameraContainer = document.getElementById('cameraContainer');
            const cameraToggleBtn = document.getElementById('cameraToggleBtn');
            const video = document.getElementById('cameraVideo');
            
            if (cameraStream) {
                // –í–∏–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
                video.srcObject = null;
                cameraContainer.classList.remove('active');
                cameraToggleBtn.textContent = 'üì∑ –£–≤—ñ–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É';
                stopQRScanner();
            } else {
                // –£–≤—ñ–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É
                try {
                    cameraStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        }
                    });
                    
                    video.srcObject = cameraStream;
                    cameraContainer.classList.add('active');
                    cameraToggleBtn.textContent = 'üì∑ –í–∏–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É';
                    
                    startQRScanner(video);
                    
                } catch (error) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –∫–∞–º–µ—Ä–∏:', error);
                    showToast('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏', 'error');
                }
            }
        }
        
        // –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —Å–∫–∞–Ω–µ—Ä QR
        function startQRScanner(video) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            qrScanner = setInterval(() => {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —Ä–æ–∑–ø—ñ–∑–Ω–∞—Ç–∏ QR-–∫–æ–¥
                    try {
                        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                        const code = attemptQRDecode(imageData);
                        
                        if (code && code.length === 6) {
                            document.getElementById('receiveCodeInput').value = code;
                            showToast(`QR-–∫–æ–¥ –∑–Ω–∞–π–¥–µ–Ω–æ: ${code}`, 'info');
                            connectToShare();
                        }
                    } catch (e) {
                        // –Ü–≥–Ω–æ—Ä—É–≤–∞—Ç–∏ –ø–æ–º–∏–ª–∫–∏ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è
                    }
                }
            }, 1000);
        }
        
        // –°–ø—Ä–æ–±–∞ —Ä–æ–∑–ø—ñ–∑–Ω–∞—Ç–∏ QR (—ñ–º—ñ—Ç–∞—Ü—ñ—è)
        function attemptQRDecode(imageData) {
            // –°–ø—Ä–æ—â–µ–Ω–∞ —ñ–º—ñ—Ç–∞—Ü—ñ—è —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è
            // –£ —Ä–µ–∞–ª—å–Ω–æ–º—É –¥–æ–¥–∞—Ç–∫—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É jsQR
            return null;
        }
        
        // –ó—É–ø–∏–Ω–∏—Ç–∏ —Å–∫–∞–Ω–µ—Ä QR
        function stopQRScanner() {
            if (qrScanner) {
                clearInterval(qrScanner);
                qrScanner = null;
            }
        }
        
        // üóÑÔ∏è INDEXEDDB –§–£–ù–ö–¶–Ü–á
        
        let database = null;
        
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –±–∞–∑–∏ –¥–∞–Ω–∏—Ö
        async function initDatabase() {
            return new Promise((resolve, reject) => {
                if (!window.indexedDB) {
                    console.log('IndexedDB –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è');
                    resolve(null);
                    return;
                }
                
                const request = indexedDB.open('FileTransferDB', 3);
                
                request.onerror = (event) => {
                    console.error('–ü–æ–º–∏–ª–∫–∞ IndexedDB:', event.target.error);
                    reject(event.target.error);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // –°—Ö–æ–≤–∏—â–µ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á
                    if (!db.objectStoreNames.contains('transfers')) {
                        const transferStore = db.createObjectStore('transfers', { keyPath: 'id' });
                        transferStore.createIndex('code', 'code', { unique: false });
                    }
                    
                    // –°—Ö–æ–≤–∏—â–µ –¥–ª—è —Ñ–∞–π–ª—ñ–≤
                    if (!db.objectStoreNames.contains('files')) {
                        const fileStore = db.createObjectStore('files', { keyPath: 'id' });
                        fileStore.createIndex('code', 'code', { unique: false });
                    }
                    
                    // –°—Ö–æ–≤–∏—â–µ –¥–ª—è —á–∞–Ω–∫—ñ–≤
                    if (!db.objectStoreNames.contains('chunks')) {
                        const chunkStore = db.createObjectStore('chunks', { keyPath: 'id' });
                        chunkStore.createIndex('code', 'code', { unique: false });
                        chunkStore.createIndex('fileIndex', 'fileIndex', { unique: false });
                    }
                };
                
                request.onsuccess = (event) => {
                    database = event.target.result;
                    console.log('–ë–∞–∑–∞ –¥–∞–Ω–∏—Ö —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞');
                    resolve(database);
                };
            });
        }
        
        // –û—Ç—Ä–∏–º–∞—Ç–∏ –±–∞–∑—É –¥–∞–Ω–∏—Ö
        async function getDatabase() {
            if (!database) {
                await initDatabase();
            }
            return database;
        }
        
        // –ó–±–µ—Ä–µ–≥—Ç–∏ –≤ IndexedDB
        async function saveToIndexedDB(db, storeName, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(data);
                
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        // –û—Ç—Ä–∏–º–∞—Ç–∏ –∑ IndexedDB
        async function getFromIndexedDB(db, storeName, indexName, value) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const index = store.index(indexName);
                const request = index.get(value);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        // –û—Ç—Ä–∏–º–∞—Ç–∏ –≤—Å—ñ –∑ IndexedDB
        async function getAllFromIndexedDB(db, storeName, indexName, value) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const index = store.index(indexName);
                const request = index.getAll(value);
                
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        // –û—á–∏—Å—Ç–∏—Ç–∏ —Å—Ç–∞—Ä—ñ –ø–µ—Ä–µ–¥–∞—á—ñ
        async function clearOldTransfers(db) {
            try {
                const transfers = await getAllFromIndexedDB(db, 'transfers', 'code', 'dummy');
                const now = Date.now();
                
                for (const transfer of transfers) {
                    if (now > transfer.expires) {
                        await clearTransferData(db, transfer.code);
                    }
                }
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –æ—á–∏—â–µ–Ω–Ω—è:', error);
            }
        }
        
        // –û—á–∏—Å—Ç–∏—Ç–∏ –¥–∞–Ω—ñ –ø–µ—Ä–µ–¥–∞—á—ñ
        async function clearTransferData(db, code) {
            // –í–∏–¥–∞–ª–∏—Ç–∏ –ø–µ—Ä–µ–¥–∞—á—É
            await deleteFromIndexedDB(db, 'transfers', 'code', code);
            
            // –í–∏–¥–∞–ª–∏—Ç–∏ —Ñ–∞–π–ª–∏
            await deleteFromIndexedDB(db, 'files', 'code', code);
            
            // –í–∏–¥–∞–ª–∏—Ç–∏ —á–∞–Ω–∫–∏
            await deleteFromIndexedDB(db, 'chunks', 'code', code);
            
            // –í–∏–¥–∞–ª–∏—Ç–∏ –∑ localStorage
            localStorage.removeItem(`share_${code}`);
            localStorage.removeItem(`connect_${code}`);
            localStorage.removeItem(`active_${code}`);
        }
        
        // –í–∏–¥–∞–ª–∏—Ç–∏ –∑ IndexedDB
        async function deleteFromIndexedDB(db, storeName, indexName, value) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const index = store.index(indexName);
                
                const request = index.openCursor(IDBKeyRange.only(value));
                
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        store.delete(cursor.primaryKey);
                        cursor.continue();
                    } else {
                        resolve();
                    }
                };
                
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        // üì¶ –î–û–ü–û–ú–Ü–ñ–ù–Ü –§–£–ù–ö–¶–Ü–á
        
        function generateRandomCode(length) {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        async function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsDataURL(file);
            });
        }
        
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            
            const icons = {
                'pdf': 'üìï',
                'doc': 'üìò', 'docx': 'üìò',
                'xls': 'üìó', 'xlsx': 'üìó',
                'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è', 'png': 'üñºÔ∏è', 'gif': 'üñºÔ∏è',
                'mp3': 'üéµ', 'wav': 'üéµ',
                'mp4': 'üé¨', 'avi': 'üé¨', 'mov': 'üé¨',
                'zip': 'üì¶', 'rar': 'üì¶',
                'txt': 'üìÑ', 'md': 'üìÑ',
                'html': 'üåê', 'htm': 'üåê',
                'js': '‚öôÔ∏è',
                'css': 'üé®',
                'exe': '‚öôÔ∏è',
                'apk': 'üì±'
            };
            
            return icons[ext] || 'üìÅ';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 –ë';
            
            const k = 1024;
            const sizes = ['–ë', '–ö–ë', '–ú–ë', '–ì–ë'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            const size = bytes / Math.pow(k, i);
            
            if (i === 0) {
                return Math.round(size) + ' ' + sizes[i];
            } else {
                return size.toFixed(2) + ' ' + sizes[i];
            }
        }
        
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }
        
        // –ó–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –≤—Ç—Ä–∞—Ç—ñ –¥–∞–Ω–∏—Ö
        window.addEventListener('beforeunload', function(e) {
            if (isTransferring || isReceiving) {
                e.preventDefault();
                e.returnValue = '–ô–¥–µ –ø–µ—Ä–µ–¥–∞—á–∞ —Ñ–∞–π–ª—ñ–≤. –í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –ø—ñ—Ç–∏?';
                return e.returnValue;
            }
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
            
            stopShareListening();
            stopReceiving();
        });
        
        // –ì–∞—Ä—è—á—ñ –∫–ª–∞–≤—ñ—à—ñ
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (document.getElementById('receiveModal').classList.contains('active')) {
                    closeReceiveModal();
                }
            }
            
            if (e.key === 'Enter' && document.activeElement.id === 'receiveCodeInput') {
                connectToShare();
            }
        });
    </script>
</body>
</html>
